# Сайт "Продуктовый помощник"
Проект Foodgram продуктовый помощник - платформа для публикации рецептов.
Cайт, на котором пользователи будут публиковать рецепты, добавлять чужие рецепты в избранное и подписываться на публикации других авторов. Сервис «Список покупок» позволит пользователям создавать список продуктов, которые нужно купить для приготовления выбранных блюд.

 * Реализован бекенд.
 * Фронтенд - одностраничное приложение на фреймворке React, которое взаимодействовует с API через удобный пользовательский интерфейс (разработан Яндекс.Практикум).

# Оглавление

1. [Стек технологий](#Стек-технологий)
2. [Описание workflow](#Описание-workflow)
3. [Базовые модели проекта](#Базовые-модели-проекта)
4. [Главная страница](#Главная-страница)
5. [Страница рецепта](#Страница-рецепта)
6. [Страница пользователя](#Страница-пользователя)
7. [Подписка на авторов](#Подписка-на-авторов)
8. [Список избранного](#Список-избранного)
9. [Список покупок](#Список-покупок)
10. [Фильтрация по тегам](#Фильтрация-по-тегам)
11. [Регистрация и авторизация](#Регистрация-и-авторизация)
12. [Что могут делать неавторизованные пользователи](#Что-могут-делать-неавторизованные-пользователи)
13. [Что могут делать авторизованные пользователи](#Что-могут-делать-авторизованные-пользователи)
14. [Что может делать администратор](#Что-может-делать-администратор)
15. [Настройки админки](#Настройки-админки)
16. [Технические требования и инфраструктура](#Технические-требования-и-инфраструктура)
17. [Шаблон наполнения .env файла](#шаблон-наполнения-env-файла)


## Стек технологий

[![Django-app workflow](https://github.com/niklukyan/foodgram-project-react/actions/workflows/foodgram_workflow.yml/badge.svg)](https://github.com/niklukyan/foodgram-project-react/actions/workflows/foodgram_workflow.yml)
[![Django](https://img.shields.io/badge/-Django-464646?style=flat&logo=Django&logoColor=56C0C0&color=008080)](https://www.djangoproject.com/)
[![Docker-compose](https://img.shields.io/badge/-Docker%20compose-464646?style=flat&logo=Docker&logoColor=56C0C0&color=008080)](https://www.docker.com/)
[![Docker Hub](https://img.shields.io/badge/-Docker%20Hub-464646?style=flat&logo=Docker&logoColor=56C0C0&color=008080)](https://www.docker.com/products/docker-hub)
[![Yandex.Cloud](https://img.shields.io/badge/-Yandex.Cloud-464646?style=flat&logo=Yandex.Cloud&logoColor=56C0C0&color=008080)](https://cloud.yandex.ru/)


## Описание workflow

* проверка кода на соответствие стандарту PEP8 (с помощью пакета flake8)
* сборка и доставка докер-образа для контейнера web на Docker Hub
* автоматический деплой проекта на боевой сервер


## Базовые модели проекта

### Рецепт - все поля обязательны для заполнения

* Автор публикации (пользователь)
* Название
* Картинка
* Текстовое описание
* Ингредиенты: продукты для приготовления блюда по рецепту. Множественное поле, выбор из предустановленного списка, с указанием количества и единицы измерения
* Тег (можно установить несколько тегов на один рецепт, выбор из предустановленных)
* Время приготовления в минутах


### Тег - все поля обязательны для заполнения и уникальны

* Название
* Цветовой HEX-код (например, #49B64E)
* Slug


### Ингредиент - все поля обязательны для заполнения

Данные об ингредиентах хранятся в нескольких связанных таблицах. В результате на стороне пользователя ингредиент должен описываться такими полями:

* Название
* Количество
* Единицы измерения


## Главная страница

Содержимое главной страницы — список первых шести рецептов, отсортированных по дате публикации (от новых к старым)

Остальные рецепты доступны на следующих страницах: внизу страницы есть пагинация


## Страница рецепта

На странице — полное описание рецепта

Для авторизованных пользователей — возможность добавить рецепт в избранное и в список покупок, возможность подписаться на автора рецепта


## Страница пользователя

На странице — имя пользователя, все рецепты, опубликованные пользователем и возможность подписаться на пользователя


[:arrow_up:Оглавление](#Оглавление)


## Подписка на авторов

Подписка на публикации доступна только авторизованному пользователю. Страница подписок доступна только владельцу.

Сценарий поведения пользователя:
1. Пользователь переходит на страницу другого пользователя или на страницу рецепта и подписывается на публикации автора кликом по кнопке «Подписаться на автора».
2. Пользователь переходит на страницу «Мои подписки» и просматривает список рецептов, опубликованных теми авторами, на которых он подписался. Сортировка записей — по дате публикации (от новых к старым).
3. При необходимости пользователь может отказаться от подписки на автора: переходит на страницу автора или на страницу его рецепта и нажимает «Отписаться от автора».


## Список избранного

Работа со списком избранного доступна только авторизованному пользователю. Список избранного может просматривать только его владелец.

Сценарий поведения пользователя:
1. Пользователь отмечает один или несколько рецептов кликом по кнопке «Добавить в избранное».
2. Пользователь переходит на страницу «Список избранного» и просматривает персональный список избранных рецептов.
3. При необходимости пользователь может удалить рецепт из избранного.


## Список покупок

Работа со списком покупок доступна авторизованным пользователям. Список покупок может просматривать только его владелец.

Сценарий поведения пользователя:
1. Пользователь отмечает один или несколько рецептов кликом по кнопке «Добавить в покупки».
2. Пользователь переходит на страницу Список покупок, там доступны все добавленные в список рецепты. Пользователь нажимает кнопку Скачать список и получает файл с суммированным перечнем и количеством необходимых ингредиентов для всех рецептов, сохранённых в «Списке покупок».
3. При необходимости пользователь может удалить рецепт из списка покупок.

Список покупок скачивается в формате .txt (или, по желанию, можно сделать выгрузку PDF).

При скачивании списка покупок ингредиенты в результирующем списке не должны дублироваться; если в двух рецептах есть сахар (в одном рецепте 5 г, в другом — 10 г), то в списке должен быть один пункт: Сахар — 15 г.

В результате список покупок может выглядеть так:
* Фарш (баранина и говядина) (г) — 600
* Сыр плавленый (г) — 200
* Лук репчатый (г) — 50
* Картофель (г) — 1000
* Молоко (мл) — 250
* Яйцо куриное (шт) — 5
* Соевый соус (ст. л.) — 8
* Сахар (г) — 230
* Растительное масло рафинированное (ст. л.) — 2
* Соль (по вкусу) — 4
* Перец черный (щепотка) — 3


## Фильтрация по тегам

При нажатии на название тега выводится список рецептов, отмеченных этим тегом. Фильтрация может проводится по нескольким тегам в комбинации «или»: если выбраны несколько тегов — в результате должны быть показаны рецепты, которые отмечены хотя бы одним из этих тегов.

При фильтрации на странице пользователя должны фильтроваться только рецепты выбранного пользователя. Такой же принцип должен соблюдаться при фильтрации списка избранного.


[:arrow_up:Оглавление](#Оглавление)


## Регистрация и авторизация

### Обязательные поля для пользователя

* Логин
* Пароль
* Email
* Имя
* Фамилия

### Уровни доступа пользователей

* Гость (неавторизованный пользователь)
* Авторизованный пользователь
* Администратор


## Что могут делать неавторизованные пользователи

* Создать аккаунт
* Просматривать рецепты на главной
* Просматривать отдельные страницы рецептов
* Просматривать страницы пользователей
* Фильтровать рецепты по тегам


## Что могут делать авторизованные пользователи

* Входить в систему под своим логином и паролем
* Выходить из системы (разлогиниваться)
* Менять свой пароль
* Создавать/редактировать/удалять собственные рецепты
* Просматривать рецепты на главной
* Просматривать страницы пользователей
* Просматривать отдельные страницы рецептов
* Фильтровать рецепты по тегам
* Работать с персональным списком избранного: добавлять в него рецепты или удалять их, просматривать свою страницу избранных рецептов
* Работать с персональным списком покупок: добавлять/удалять любые рецепты, выгружать файл с количеством необходимых ингридиентов для рецептов из списка покупок
* Подписываться на публикации авторов рецептов и отменять подписку, просматривать свою страницу подписок


## Что может делать администратор

Администратор обладает всеми правами авторизованного пользователя

Плюс к этому он может:
* изменять пароль любого пользователя
* создавать/блокировать/удалять аккаунты пользователей
* редактировать/удалять любые рецепты
* добавлять/удалять/редактировать ингредиенты
* добавлять/удалять/редактировать теги


## Настройки админки

### Модели

* Вывести все модели с возможностью редактирования и удаления записей

### Модель пользователей:

* Добавить фильтр списка по email и имени пользователя

### Модель рецептов:

* В списке рецептов вывести название и автора рецепта
* Добавить фильтры по автору, названию рецепта, тегам
* На странице рецепта вывести общее число добавлений этого рецепта в избранное

### Модель ингредиентов:

* В список вывести название ингредиента и единицы измерения
* Добавить фильтр по названию


## Технические требования и инфраструктура

* Проект должен использовать базу данных PostgreSQL
* Код должен находиться в репозитории `foodgram-project-react`
* В Django-проекте должен быть файл `requirements.txt` со всеми зависимостями
* Проект нужно запустить в трёх контейнерах (nginx, PostgreSQL и Django) (контейнер frontend используется лишь для подготовки файлов) через docker-compose на вашем сервере в Яндекс.Облаке. Образ с проектом должен быть запушен на Docker Hub


----------
<!--
## Тестирование и описание работы:
Вы можете склонировать проект у себе на локальную машину, далее создать свой репозиторий с проектом. Для запуска приложения необходимо создать сервер, сдружить его с Вашим GitHub, создать 2 своих репозитроия на DockerHub (frontend/backend) и далее совершенствовать проект, который будет пересобираться и тестироваться с помощью workflow Actions GitHub по пушу (push) в главную ветку (с отправкой отчета в телеграм). 

По окончании запуска приложения, Вы можете вручную создать суперпользователя и далее все остальные объекты. Для логической целостности, при создании рецептов необходимо иметь теги и ингредиенты в БД.
Предлагается загрузить первоначальные данные в БД при помощи фикстур (см. раздел 5).
Юзеры фикстур:
```
superuser@mail.ru
adminuser@mail.ru
user@mail.ru
```
Их общий пароль:
```
allTestUsersPASS$!
```


---------

## Запуск приложения.
### 1.Склонировать репозиторий на локальную машину
```
git clone git@github.com:NikLukyan/foodgram-project-react.git
```
### 2.Настройка сервера (на Ubuntu)
Подключаемся к виртуальной машине с линукс
```
ssh admin@XXX.XXX.XXX.XXX
```
обновим индекс менеджера пакетов apt
```
sudo apt update
```
обновим установленные в системе пакеты
```
sudo apt upgrade -y
```
установим систему контроля версий, утилиту для создания виртуального окружения и менеджер пакетов
```
sudo apt install python3-pip python3-venv git -y
```
##### установим Docker и docker-compose 

Установка утилиты для скачивания файлов и ее запуск
```
sudo apt install curl
sudo curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo apt remove docker docker-engine docker.io containerd runc
sudo apt update
```
Установить необходимые пакеты для загрузки через https
```
sudo apt install \
  apt-transport-https \
  ca-certificates \
  curl \
  gnupg-agent \
  software-properties-common -y
```
В консоли должно вывестись ОК.
```
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

sudo apt update 

sudo apt install docker-ce docker-compose -y

sudo systemctl status docker
```
##### Сдружить GitHub и сервер 
__
Дадим доступ к сервису GitHub нашему серверу, сгенерируем публичный ssh-ключ
```
ssh-keygen (Enter, плюс ввод создание пароля для ключа)
```
вывод ключа
```
cat ~/.ssh/id_rsa.pub
```
GitHub-> Settings->SSH and GPG keys->Add SSH key->добавить ключ его название
__
Перенесем файлы из проекта docker-compose.yaml и nginx/default.conf на сервер,
в home/<ваш_username>/docker-compose.yaml и home/<ваш_username>/nginx/default.conf соответственно,
так как на основании них и будут собраны все настройки проекта.
На сервере:
```
pwd   # /home/admin
mkdir nginx
```
На рабочем компьютере, в папке infra/:
копируем yaml
```
scp docker-compose.yml admin@158.160.9.55:/home/admin
scp nginx.conf admin@158.160.9.55:/home/admin/nginx
```

### 3.Создание докер-образов на DockerHub.
Запушим докер-образы на DockerHub (по лекалам Dockerfile).
```
sudo docker build -t niklukyan/foodgram_frontend:latest .
sudo docker build -t niklukyan/foodgram_backend:latest .
sudo docker login -u admin (пароль)
sudo docker push niklukyan/foodgram_frontend:latest
sudo docker push niklukyan/foodgram_backend:latest
```

### 4.DevOps (Development Operations) —  методика увеличения скорости, качества и безопасности разработки.
Continuous Integration (англ. «непрерывная интеграция», сокращенно CI) состоит в том, чтобы после внесения изменений в любую часть кода проводилось тестирование не только того модуля, который был изменён, но и всего проекта.
GitHub Actions — это облачный сервис, инструмент для автоматизации процессов тестирования и деплоя проектов.
Для подключения GitHub Actions создана директория .github/workflows, а в ней — yml-файл.
В файле .yml декларативно описывается workflow, процесс автоматизации: пошаговые команды и условия их выполнения. 
##### Добавим переменные окружения на GitHub Actions.
__
niklukyan/foodgram-project-react -> Settings -> Secrets -> Actions -> New repositiry secret:

* DOCKER_PASSWORD # пароль от DockerHub
* DOCKER_USERNAME # имя пользователя на DockerHub
* DB_ENGINE=django.db.backends.postgresql # указываем, что работаем с postgresql
* DB_NAME = postgres # имя базы данных
* POSTGRES_USER = postgres # логин для подключения к базе данных
* POSTGRES_PASSWORD = postgres # пароль для подключения к БД (установите свой)
* DB_HOST = db # название сервиса (контейнера!)
* DB_PORT = 5432 # порт для подключения к БД 
* TELEGRAM_TO # id своего телеграм-аккаунта (@userinfobot)
* TELEGRAM_TOKEN # токен бота (@BotFather)
* HOST # ip-адрес сервера
* PASSPHRASE  # пароль от ssh-ключа, на сервере 
* USER  # логин пользователя на сервере, от ssh-ключа
* SSH_KEY # приватный ssh ключ локального комьютера имеющего доступ к серверу (cat ~/.ssh/id_rsa)

##### Теперь при коммите в главную ветку, наше приложение будет тестироваться и деплоиться на сервер.

### 5.Инициализация БД и статики (только после первого деплоя)
Подключаемся к серверу через ssh и выполняем миграции БД.
```
sudo docker-compose exec web python manage.py makemigrations
sudo docker-compose exec web python manage.py migrate
```
Собираем статические файлы
```
sudo docker-compose exec web python manage.py collectstatic --no-input
```
По желанию, загружаем фикстуры
```
sudo docker-compose exec web python manage.py loaddata fixtures.json
```

### Под капотом

При внесении изменения в проект (master-ветка) - происходит workflow, запуск блоков команд.
Последовательно будут выполнены следующие блоки:
* "tests" - тестирование проекта на соответствие PEP-8 и тестам.
* "build_and_push_to_docker_hub" - сборка образов (image) для запуска docker-контейнеров и отправка их на DockerHub.
* "deploy" - деплой проекта на сервере с образов уже находящихся на DockerHub.
Происходит копирование файлов из репозитория на сервер, сборка и запуск контейнеров:
  - docker-compose.yaml, необходимый для сборки трех контейнеров:
    + db - контейнер базы данных.
    + web- контейнер Django приложения + wsgi-сервер gunicorn.
    + frontend - контейнер с файлами фронтенда и статики (после сборки - останавливается).
    + nginx - проксирующий веб-сервер.
* "send_message" - после сборки и запуска контейнеров происходит отправка сообщения в телеграм, об успешном окончании workflow.

## Останов приложения (контейнеров)
### Завершить работу контейнеров можно командой
```
sudo docker-compose down -v
```
### Сброс данных (при необходимости). 
```
sudo docker system prune --all --force
sudo docker system prune -a --volumes
```

## Авторы

* **Фронтенд - Яндекс.Практикум**

* **Бекенд - Лукьянчук Никита** 
